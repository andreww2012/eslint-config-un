import type {IGraphQLConfig} from '@graphql-eslint/eslint-plugin';
import {
  ERROR,
  GLOB_ASTRO,
  GLOB_EMBER_GLIMMER,
  GLOB_FLOW,
  GLOB_GRAPHQL,
  GLOB_JS_TS_X,
  GLOB_SVELTE,
  OFF,
  type RuleSeverity,
  WARNING,
} from '../constants';
import {type UnConfigOptions, createConfigBuilder} from '../eslint';
import {pluginsLoaders} from '../plugins';
import type {PrettifyShallow} from '../types';
import {assignDefaults, doesPackageExist, getKeysOfTruthyValues, pickBy} from '../utils';
import type {UnConfigFn} from './index';

export interface GraphqlEslintConfigOptions extends UnConfigOptions<'graphql'> {
  /**
   * Files for which GraphQL processor will be used.
   * "Under the hood, the processor extracts schema and operation files from these files
   * and treats them as virtual GraphQL documents with .graphql extensions"
   * - [plugin docs](https://the-guild.dev/graphql/eslint/docs/usage/js)
   *
   * By default, the processor will be used on **all** files.
   * @default true
   */
  configJsProcessor?: boolean | PrettifyShallow<Pick<UnConfigOptions, 'files' | 'ignores'>>;

  /**
   * Disable all the rules requiring GraphQL Operations specified in GraphQL config
   * (via `documents` option) in order to work:
   * [`known-fragment-names`](https://the-guild.dev/graphql/eslint/rules/known-fragment-names), [`no-one-place-fragments`](https://the-guild.dev/graphql/eslint/rules/no-one-place-fragments), [`no-undefined-variables`](https://the-guild.dev/graphql/eslint/rules/no-undefined-variables), [`no-unused-fields`](https://the-guild.dev/graphql/eslint/rules/no-unused-fields), [`no-unused-fragments`](https://the-guild.dev/graphql/eslint/rules/no-unused-fragments), [`no-unused-variables`](https://the-guild.dev/graphql/eslint/rules/no-unused-variables), [`require-import-fragment`](https://the-guild.dev/graphql/eslint/rules/require-import-fragment), [`require-selections`](https://the-guild.dev/graphql/eslint/rules/require-selections), [`selection-set-depth`](https://the-guild.dev/graphql/eslint/rules/selection-set-depth), [`unique-fragment-name`](https://the-guild.dev/graphql/eslint/rules/unique-fragment-name), [`unique-operation-name`](https://the-guild.dev/graphql/eslint/rules/unique-operation-name)
   * @default false
   */
  disableRulesRequiringOperations?: boolean;

  /**
   * Disable all the rules requiring GraphQL Schema specified in GraphQL config
   * (via `schema` option) in order to work:
   * [`no-deprecated`](https://the-guild.dev/graphql/eslint/rules/no-deprecated), [`no-root-type`](https://the-guild.dev/graphql/eslint/rules/no-root-type), [`no-scalar-result-type-on-mutation`](https://the-guild.dev/graphql/eslint/rules/no-scalar-result-type-on-mutation), [`no-unreachable-types`](https://the-guild.dev/graphql/eslint/rules/no-unreachable-types), [`no-unused-fields`](https://the-guild.dev/graphql/eslint/rules/no-unused-fields), [`relay-edge-types`](https://the-guild.dev/graphql/eslint/rules/relay-edge-types), [`relay-page-info`](https://the-guild.dev/graphql/eslint/rules/relay-page-info), [`require-field-of-type-query-in-mutation-result`](https://the-guild.dev/graphql/eslint/rules/require-field-of-type-query-in-mutation-result), [`require-nullable-result-in-root`](https://the-guild.dev/graphql/eslint/rules/require-nullable-result-in-root), [`require-selections`](https://the-guild.dev/graphql/eslint/rules/require-selections), [`strict-id-in-types`](https://the-guild.dev/graphql/eslint/rules/strict-id-in-types)
   * @default false
   */
  disableRulesRequiringSchema?: boolean;

  /**
   * Provides [GraphQL Config](https://npmjs.com/graphql-config). Normally is not required
   * as it should be automatically found by the plugin. Will be assigned to
   * `languageOptions.parserOptions.graphQLConfig`.
   */
  graphqlConfig?: IGraphQLConfig;

  /**
   * Require queries, mutations, subscriptions or fragments to be located in separate files.
   * By default, all of them are required to be in separate files.
   */
  requireSeparateFilesFor?: Partial<
    Record<'fragment' | 'query' | 'mutation' | 'subscription', boolean>
  >;
}

export const graphqlUnConfig: UnConfigFn<'graphql'> = async (context) => {
  const optionsRaw = context.rootOptions.configs?.graphql;
  const optionsResolved = assignDefaults(optionsRaw, {
    configJsProcessor: true,
    disableRulesRequiringOperations: false,
    disableRulesRequiringSchema: false,
  } satisfies GraphqlEslintConfigOptions);

  const [eslintPluginGraphql, isRelayInstalled] = await Promise.all([
    pluginsLoaders.graphql(),
    doesPackageExist('relay-runtime'),
  ]);

  const {
    configJsProcessor,
    graphqlConfig,
    requireSeparateFilesFor = {},
    disableRulesRequiringOperations,
    disableRulesRequiringSchema,
  } = optionsResolved;

  const configBuilderProcessor = createConfigBuilder(context, configJsProcessor, null);
  configBuilderProcessor?.addConfig(
    [
      'graphql/processor',
      {
        includeDefaultFilesAndIgnores: true,
        // "Provided file type must be one of .js, .mjs, .cjs, .jsx, .ts, .mts, .cts, .tsx, .flow, .flow.js, .flow.jsx, .vue, .svelte, .astro, .gts, .gjs"
        // "Preprocessing error: Processing of `.vue` files is no longer supported, follow the new official vue example for ESLint's flat config https://github.com/dimaMachina/graphql-eslint/tree/master/examples/vue-code-file"
        filesFallback: [GLOB_JS_TS_X, GLOB_FLOW, GLOB_SVELTE, GLOB_ASTRO, GLOB_EMBER_GLIMMER],
      },
    ],
    {
      processor: eslintPluginGraphql.processor,
    },
  );

  const configBuilder = createConfigBuilder(context, optionsResolved, 'graphql');

  const getRelaySeverity = (severity: RuleSeverity) => (isRelayInstalled ? severity : OFF);
  const getRuleRequiresOperationsSeverity = (severity: RuleSeverity) =>
    disableRulesRequiringOperations ? OFF : severity;
  const getRuleRequiresSchemaSeverity = (severity: RuleSeverity) =>
    disableRulesRequiringSchema ? OFF : severity;

  // Legend:
  // üü¢ - in recommended (schema)
  // üîµ - in recommended (operations)
  // üì¶ - wrapper around `graphql-js` validation function (see https://github.com/graphql/graphql-js/tree/HEAD/src/validation)
  // üñ•Ô∏è - requires GraphQL Operations
  // üìÉ - requires GraphQL Schema

  configBuilder
    ?.addConfig(
      [
        'graphql',
        {
          includeDefaultFilesAndIgnores: true,
          filesFallback: [GLOB_GRAPHQL],
          doNotIgnoreMarkdown: true,
        },
      ],
      {
        languageOptions: {
          parser: eslintPluginGraphql.parser,
          ...(graphqlConfig && {
            parserOptions: {
              graphQLConfig: graphqlConfig,
            },
          }),
        },
      },
    )
    .addRule('alphabetize', OFF)
    .addRule('description-style', OFF) // üü¢
    .addRule('executable-definitions', ERROR) // üîµüì¶
    .addRule('fields-on-correct-type', ERROR) // üîµüì¶
    .addRule('fragments-on-composite-type', ERROR) // üîµüì¶
    .addRule('input-name', OFF)
    .addRule('known-argument-names', ERROR) // üü¢üîµüì¶
    .addRule('known-directives', ERROR) // üü¢üîµüì¶
    .addRule('known-fragment-names', getRuleRequiresOperationsSeverity(ERROR)) // üîµüì¶üñ•Ô∏è
    .addRule('known-type-names', ERROR) // üü¢üîµüì¶
    .addRule('lone-anonymous-operation', ERROR) // üîµüì¶
    .addRule('lone-executable-definition', ERROR, [
      {
        // @ts-expect-error too strict type
        ignore: getKeysOfTruthyValues(
          pickBy(requireSeparateFilesFor, (v) => !v),
          true,
        ),
      },
    ])
    .addRule('lone-schema-definition', ERROR) // üü¢üì¶
    .addRule('match-document-filename', OFF)
    .addRule('naming-convention', ERROR, [
      // Copied from `recommended` config:
      {
        types: 'PascalCase',
        FieldDefinition: 'camelCase',
        InputValueDefinition: 'camelCase',
        Argument: 'camelCase',
        DirectiveDefinition: 'camelCase',
        EnumValueDefinition: 'UPPER_CASE',
        'FieldDefinition[parent.name.value=Query]': {
          forbiddenPrefixes: ['query', 'get'],
          forbiddenSuffixes: ['Query'],
        },
        'FieldDefinition[parent.name.value=Mutation]': {
          forbiddenPrefixes: ['mutation'],
          forbiddenSuffixes: ['Mutation'],
        },
        'FieldDefinition[parent.name.value=Subscription]': {
          forbiddenPrefixes: ['subscription'],
          forbiddenSuffixes: ['Subscription'],
        },
        'EnumTypeDefinition,EnumTypeExtension': {
          forbiddenPrefixes: ['Enum'],
          forbiddenSuffixes: ['Enum'],
        },
        'InterfaceTypeDefinition,InterfaceTypeExtension': {
          forbiddenPrefixes: ['Interface'],
          forbiddenSuffixes: ['Interface'],
        },
        'UnionTypeDefinition,UnionTypeExtension': {
          forbiddenPrefixes: ['Union'],
          forbiddenSuffixes: ['Union'],
        },
        'ObjectTypeDefinition,ObjectTypeExtension': {
          forbiddenPrefixes: ['Type'],
          forbiddenSuffixes: ['Type'],
        },

        VariableDefinition: 'camelCase',
        OperationDefinition: {
          style: 'PascalCase',
          forbiddenPrefixes: ['Query', 'Mutation', 'Subscription', 'Get'],
          forbiddenSuffixes: ['Query', 'Mutation', 'Subscription'],
        },
        FragmentDefinition: {
          style: 'PascalCase',
          forbiddenPrefixes: ['Fragment'],
          forbiddenSuffixes: ['Fragment'],
        },
      },
    ]) // üü¢üîµ
    .addRule('no-anonymous-operations', ERROR) // üîµ
    .addRule('no-deprecated', getRuleRequiresSchemaSeverity(WARNING)) // üîµüìÉ
    .addRule('no-duplicate-fields', ERROR) // üîµ
    .addRule('no-fragment-cycles', ERROR) // üîµüì¶
    .addRule('no-hashtag-description', ERROR) // üü¢
    .addRule('no-one-place-fragments', getRuleRequiresOperationsSeverity(ERROR)) // üñ•Ô∏è
    .addRule('no-root-type', getRuleRequiresSchemaSeverity(OFF)) // üìÉ
    .addRule('no-scalar-result-type-on-mutation', getRuleRequiresSchemaSeverity(ERROR)) // üìÉ
    .addRule('no-typename-prefix', ERROR) // üü¢
    .addRule('no-undefined-variables', getRuleRequiresOperationsSeverity(ERROR)) // üîµüì¶üñ•Ô∏è
    .addRule('no-unreachable-types', getRuleRequiresSchemaSeverity(ERROR)) // üü¢üìÉ
    .addRule(
      'no-unused-fields',
      getRuleRequiresOperationsSeverity(getRuleRequiresSchemaSeverity(WARNING)),
    ) // üñ•Ô∏èüìÉ
    .addRule('no-unused-fragments', getRuleRequiresOperationsSeverity(ERROR)) // üîµüì¶üñ•Ô∏è
    .addRule('no-unused-variables', getRuleRequiresOperationsSeverity(ERROR)) // üîµüì¶üñ•Ô∏è
    .addRule('one-field-subscriptions', ERROR) // üîµüì¶
    .addRule('overlapping-fields-can-be-merged', ERROR) // üîµüì¶
    .addRule('possible-fragment-spread', ERROR) // üîµüì¶
    .addRule('possible-type-extension', ERROR) // üü¢üì¶
    .addRule('provided-required-arguments', ERROR) // üü¢üîµüì¶
    .addRule('relay-arguments', getRelaySeverity(ERROR))
    .addRule('relay-connection-types', getRelaySeverity(ERROR))
    .addRule('relay-edge-types', getRuleRequiresSchemaSeverity(getRelaySeverity(ERROR))) // üìÉ
    .addRule('relay-page-info', getRuleRequiresSchemaSeverity(getRelaySeverity(ERROR))) // üìÉ
    .addRule('require-deprecation-date', OFF)
    .addRule('require-deprecation-reason', WARNING) // üü¢
    .addRule('require-description', OFF, [
      // Copied from `recommended` config
      {types: true, DirectiveDefinition: true, rootField: true},
    ]) // üü¢
    .addRule('require-field-of-type-query-in-mutation-result', getRuleRequiresSchemaSeverity(OFF)) // üìÉ
    .addRule('require-import-fragment', getRuleRequiresOperationsSeverity(WARNING)) // üñ•Ô∏è
    .addRule('require-nullable-fields-with-oneof', ERROR)
    .addRule('require-nullable-result-in-root', getRuleRequiresSchemaSeverity(ERROR)) // üìÉ
    .addRule(
      'require-selections',
      getRuleRequiresOperationsSeverity(getRuleRequiresSchemaSeverity(ERROR)),
    ) // üîµüñ•Ô∏èüìÉ
    .addRule('require-type-pattern-with-oneof', OFF)
    .addRule('scalar-leafs', ERROR) // üîµüì¶
    .addRule('selection-set-depth', getRuleRequiresOperationsSeverity(ERROR), [{maxDepth: 7}]) // üîµüñ•Ô∏è
    .addRule('strict-id-in-types', getRuleRequiresSchemaSeverity(ERROR)) // üü¢üìÉ
    .addRule('unique-argument-names', ERROR) // üîµüì¶
    .addRule('unique-directive-names-per-location', ERROR) // üü¢üîµüì¶
    .addRule('unique-directive-names', ERROR) // üü¢üì¶
    .addRule('unique-enum-value-names', ERROR) // üü¢
    .addRule('unique-field-definition-names', ERROR) // üü¢üì¶
    .addRule('unique-fragment-name', getRuleRequiresOperationsSeverity(ERROR)) // üîµüñ•Ô∏è
    .addRule('unique-input-field-names', ERROR) // üîµüì¶
    .addRule('unique-operation-name', getRuleRequiresOperationsSeverity(ERROR)) // üîµüñ•Ô∏è
    .addRule('unique-operation-types', ERROR) // üü¢üì¶
    .addRule('unique-type-names', ERROR) // üü¢üì¶
    .addRule('unique-variable-names', ERROR) // üîµüì¶
    .addRule('value-literals-of-correct-type', ERROR) // üîµüì¶
    .addRule('variables-are-input-types', ERROR) // üîµüì¶
    .addRule('variables-in-allowed-position', ERROR) // üîµüì¶
    .addOverrides();

  return {
    configs: [configBuilderProcessor, configBuilder],
    optionsResolved,
  };
};
